# =============================================================================
# Manage GCP Secrets via GitHub Actions
# =============================================================================
# Manual workflow to create/update secrets in GCP Secret Manager.
# Provides audit trail through GitHub Actions logs.
#
# Usage:
#   1. Go to Actions tab in GitHub
#   2. Select "Manage Secrets" workflow
#   3. Click "Run workflow"
#   4. Choose action (create/update) and provide secret name + value
# =============================================================================

name: Manage Secrets

on:
    workflow_dispatch:
        inputs:
            action:
                description: "Action to perform"
                required: true
                type: choice
                options:
                    - create
                    - update
                    - delete
                    - list
            secret_name:
                description: "Secret name in GCP (e.g., github-my-secret)"
                required: false
                type: string
            secret_value:
                description: "Secret value (leave empty for delete/list)"
                required: false
                type: string
            sync_to_github:
                description: "Also sync to GitHub Secrets?"
                required: false
                type: boolean
                default: false
            github_secret_name:
                description: "GitHub secret name (if different from GCP name)"
                required: false
                type: string

jobs:
    manage-secret:
        name: ${{ inputs.action }} Secret
        runs-on: ubuntu-latest
        permissions:
            contents: read
            id-token: write

        steps:
            - uses: actions/checkout@v4

            - name: Authenticate to Google Cloud
              uses: google-github-actions/auth@v3
              with:
                  workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
                  service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

            - name: Set up Cloud SDK
              uses: google-github-actions/setup-gcloud@v2

            - name: Validate inputs
              if: inputs.action != 'list'
              run: |
                  if [ -z "${{ inputs.secret_name }}" ]; then
                    echo "❌ Error: secret_name is required for ${{ inputs.action }}"
                    exit 1
                  fi

                  if [ "${{ inputs.action }}" = "create" ] || [ "${{ inputs.action }}" = "update" ]; then
                    if [ -z "${{ inputs.secret_value }}" ]; then
                      echo "❌ Error: secret_value is required for ${{ inputs.action }}"
                      exit 1
                    fi
                  fi

            - name: List all secrets
              if: inputs.action == 'list'
              run: |
                  echo "## GCP Secret Manager - All Secrets" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Secret Name | Created |" >> $GITHUB_STEP_SUMMARY
                  echo "|-------------|---------|" >> $GITHUB_STEP_SUMMARY
                  gcloud secrets list --format="table[no-heading](name,createTime)" | while read name created; do
                    echo "| $name | $created |" >> $GITHUB_STEP_SUMMARY
                  done

            - name: Create secret
              if: inputs.action == 'create'
              run: |
                  echo "Creating secret: ${{ inputs.secret_name }}"
                  echo -n "${{ inputs.secret_value }}" | gcloud secrets create ${{ inputs.secret_name }} --data-file=-

                  echo "## ✅ Secret Created" >> $GITHUB_STEP_SUMMARY
                  echo "- **Name:** \`${{ inputs.secret_name }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "- **Created by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY

            - name: Update secret
              if: inputs.action == 'update'
              run: |
                  echo "Updating secret: ${{ inputs.secret_name }}"
                  echo -n "${{ inputs.secret_value }}" | gcloud secrets versions add ${{ inputs.secret_name }} --data-file=-

                  echo "## ✅ Secret Updated" >> $GITHUB_STEP_SUMMARY
                  echo "- **Name:** \`${{ inputs.secret_name }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "- **Updated by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY

            - name: Delete secret
              if: inputs.action == 'delete'
              run: |
                  echo "Deleting secret: ${{ inputs.secret_name }}"
                  gcloud secrets delete ${{ inputs.secret_name }} --quiet

                  echo "## ⚠️ Secret Deleted" >> $GITHUB_STEP_SUMMARY
                  echo "- **Name:** \`${{ inputs.secret_name }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "- **Deleted by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY

            - name: Sync to GitHub Secrets
              if: inputs.sync_to_github == true && (inputs.action == 'create' || inputs.action == 'update')
              env:
                  GH_TOKEN: ${{ secrets.GH_PAT_SECRETS }}
              run: |
                  GITHUB_SECRET_NAME="${{ inputs.github_secret_name }}"
                  if [ -z "$GITHUB_SECRET_NAME" ]; then
                    # Convert GCP name to GitHub format (e.g., github-my-secret -> MY_SECRET)
                    GITHUB_SECRET_NAME=$(echo "${{ inputs.secret_name }}" | sed 's/^github-//' | tr '[:lower:]-' '[:upper:]_')
                  fi

                  echo "Syncing to GitHub secret: $GITHUB_SECRET_NAME"
                  echo -n "${{ inputs.secret_value }}" | gh secret set "$GITHUB_SECRET_NAME"

                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Also synced to GitHub" >> $GITHUB_STEP_SUMMARY
                  echo "- **GitHub Secret:** \`$GITHUB_SECRET_NAME\`" >> $GITHUB_STEP_SUMMARY
