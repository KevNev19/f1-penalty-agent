# =============================================================================
# Sync Secrets from GCP Secret Manager to GitHub Secrets
# =============================================================================
# Runs daily to ensure GitHub secrets match the source of truth in GCP.
# This allows managing all secrets in one place (GCP Secret Manager).
#
# To add a new secret to sync:
#   1. Create it in GCP using the "Manage Secrets" workflow
#   2. Add it to the SECRETS_MAP below
#
# Bootstrap secrets (not synced - required for this workflow to run):
#   - GCP_WORKLOAD_IDENTITY_PROVIDER
#   - GCP_SERVICE_ACCOUNT
#   - GCP_PROJECT_ID
# =============================================================================

name: Sync Secrets

on:
    schedule:
        - cron: "0 2 * * *" # Daily at 2 AM UTC
    workflow_dispatch: # Manual trigger

env:
    # Map of GCP secret names to GitHub secret names
    # Format: gcp_secret_name:github_secret_name
    SECRETS_MAP: |
        github-firebase-service-account:FIREBASE_SERVICE_ACCOUNT
        f1-agent-google-api-key:GOOGLE_API_KEY
        github-qdrant-account-id:QDRANT_ACCOUNT_ID
        github-qdrant-cloud-api-key:QDRANT_CLOUD_API_KEY

jobs:
    sync-secrets:
        name: Sync from GCP Secret Manager
        runs-on: ubuntu-latest
        permissions:
            contents: read
            id-token: write

        steps:
            - uses: actions/checkout@v4

            - name: Authenticate to Google Cloud
              uses: google-github-actions/auth@v3
              with:
                  workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
                  service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

            - name: Set up Cloud SDK
              uses: google-github-actions/setup-gcloud@v2

            - name: Sync secrets to GitHub
              env:
                  GH_TOKEN: ${{ secrets.GH_PAT_SECRETS }}
              run: |
                  echo "## Secrets Sync Report" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| GCP Secret | GitHub Secret | Status |" >> $GITHUB_STEP_SUMMARY
                  echo "|------------|---------------|--------|" >> $GITHUB_STEP_SUMMARY

                  # Check if GH_PAT_SECRETS is set
                  if [ -z "$GH_TOKEN" ]; then
                    echo "⚠️ GH_PAT_SECRETS not set - skipping GitHub sync"
                    echo "| - | - | ⚠️ GH_PAT_SECRETS not configured |" >> $GITHUB_STEP_SUMMARY
                    exit 0
                  fi

                  # Parse and sync each secret
                  while IFS=: read -r gcp_name github_name; do
                    # Skip empty lines
                    [ -z "$gcp_name" ] && continue

                    echo "Syncing $gcp_name -> $github_name"

                    # Try to fetch from GCP
                    if SECRET_VALUE=$(gcloud secrets versions access latest --secret="$gcp_name" 2>/dev/null); then
                      # Sync to GitHub
                      if echo -n "$SECRET_VALUE" | gh secret set "$github_name" 2>/dev/null; then
                        echo "| \`$gcp_name\` | \`$github_name\` | ✅ Synced |" >> $GITHUB_STEP_SUMMARY
                      else
                        echo "| \`$gcp_name\` | \`$github_name\` | ❌ GitHub sync failed |" >> $GITHUB_STEP_SUMMARY
                      fi
                    else
                      echo "| \`$gcp_name\` | \`$github_name\` | ⚠️ Not found in GCP |" >> $GITHUB_STEP_SUMMARY
                    fi
                  done <<< "$SECRETS_MAP"

                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "---" >> $GITHUB_STEP_SUMMARY
                  echo "*Synced at $(date -u) by @${{ github.actor }}*" >> $GITHUB_STEP_SUMMARY
